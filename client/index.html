<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSS Blog</title>
  <link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-ysQoXrI1kTwWwXImQxGc1dQc5sKXc5teLoI0lp4rWuIwoMvVJE9idh+NRONSOX4p"
  />
  <link rel="stylesheet" href="style.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    function App() {
      const [posts, setPosts] = useState([]);
      const [token, setToken] = useState(null);
      const [showLogin, setShowLogin] = useState(false);
      const [isSignUp, setIsSignUp] = useState(false);
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [newTitle, setNewTitle] = useState('');
      const [newContent, setNewContent] = useState('');
      const [editingId, setEditingId] = useState(null);
      const [editTitle, setEditTitle] = useState('');
      const [editContent, setEditContent] = useState('');
      const [showCreate, setShowCreate] = useState(false);

      const loadPosts = () => {
        fetch('/api/posts')
          .then(res => res.json())
          .then(data => setPosts(data))
          .catch(err => console.error(err));
      };

      useEffect(loadPosts, []);

      const resetAuthForm = () => {
        setUsername('');
        setPassword('');
        setConfirmPassword('');
      };

      const login = e => {
        e.preventDefault();
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const found = users.find(
          u => u.username === username && u.password === password
        );
        if (found) {
          setToken(username);
          setShowLogin(false);
          resetAuthForm();
        } else {
          alert('Invalid credentials');
        }
      };

      const signUp = e => {
        e.preventDefault();
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        if (users.some(u => u.username === username)) {
          alert('Username already exists');
          return;
        }
        if (password !== confirmPassword) {
          alert('Passwords do not match');
          return;
        }
        users.push({ username, password });
        localStorage.setItem('users', JSON.stringify(users));
        setToken(username);
        setShowLogin(false);
        resetAuthForm();
        setIsSignUp(false);
      };

      const logout = () => {
        setToken(null);
      };

      const createPost = e => {
        e.preventDefault();
        fetch('/api/posts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token
          },
          body: JSON.stringify({ title: newTitle, content: newContent })
        })
          .then(res => res.json())
          .then(post => {
            setPosts([post, ...posts]);
            setNewTitle('');
            setNewContent('');
            setShowCreate(false);
          });
      };

      const startEdit = post => {
        setEditingId(post._id);
        setEditTitle(post.title);
        setEditContent(post.content);
      };

      const cancelEdit = () => {
        setEditingId(null);
      };

      const saveEdit = id => {
        fetch(`/api/posts/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token
          },
          body: JSON.stringify({ title: editTitle, content: editContent })
        })
          .then(res => res.json())
          .then(updated => {
            setPosts(posts.map(p => (p._id === id ? updated : p)));
            setEditingId(null);
          });
      };

      const deletePost = id => {
        fetch(`/api/posts/${id}`, {
          method: 'DELETE',
          headers: { Authorization: token }
        }).then(() => setPosts(posts.filter(p => p._id !== id)));
      };

      return (
        <div className="container my-5">
        <div className="login-container d-flex justify-content-end mb-3">
            {token ? (
              <div>
                <button
                  className="btn btn-primary me-2"
                  onClick={() => setShowCreate(true)}
                >
                  New Post
                </button>
                <button className="btn btn-outline-secondary" onClick={logout}>
                  Logout
                </button>
              </div>
            ) : (
              <button
                className="btn btn-primary"
                onClick={() => setShowLogin(s => !s)}
              >
                Login
              </button>
            )}
          </div>
          {showLogin && !token && (
            <div
              className="modal-overlay"
              onClick={() => {
                setShowLogin(false);
                setIsSignUp(false);
                resetAuthForm();
              }}
            >
              <div className="modal-dialog" onClick={e => e.stopPropagation()}>
                <div className="modal-content position-relative p-4">
                  <button
                    type="button"
                    className="btn-close position-absolute top-0 end-0 m-2"
                    onClick={() => {
                      setShowLogin(false);
                      setIsSignUp(false);
                      resetAuthForm();
                    }}
                  >
                    X
                  </button>
                  {isSignUp ? (
                    <form onSubmit={signUp}>
                      <h5 className="mb-3">Sign Up</h5>
                      <input
                        className="form-control mb-2"
                        placeholder="Username"
                        value={username}
                        onChange={e => setUsername(e.target.value)}
                      />
                      <input
                        type="password"
                        className="form-control mb-2"
                        placeholder="Password"
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                      />
                      <input
                        type="password"
                        className="form-control mb-3"
                        placeholder="Confirm Password"
                        value={confirmPassword}
                        onChange={e => setConfirmPassword(e.target.value)}
                      />
                      <div className="d-flex justify-content-between">
                        <button className="btn btn-primary" type="submit">
                          Sign Up
                        </button>
                        <button
                          type="button"
                          className="btn btn-link"
                          onClick={() => {
                            setIsSignUp(false);
                            resetAuthForm();
                          }}
                        >
                          Back to Login
                        </button>
                      </div>
                    </form>
                  ) : (
                    <form onSubmit={login}>
                      <h5 className="mb-3">Login</h5>
                      <input
                        className="form-control mb-2"
                        placeholder="Username"
                        value={username}
                        onChange={e => setUsername(e.target.value)}
                      />
                      <input
                        type="password"
                        className="form-control mb-2"
                        placeholder="Password"
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                      />
                      <div className="d-flex justify-content-between align-items-center">
                        <button className="btn btn-success" type="submit">
                          Login
                        </button>
                        <div>
                          <button
                            type="button"
                            className="btn btn-link me-2 p-0"
                            onClick={() => {
                              setIsSignUp(true);
                              resetAuthForm();
                            }}
                          >
                            Sign Up
                          </button>
                          <a href="forgot.html" className="btn btn-link p-0">
                            Forgot Password?
                          </a>
                        </div>
                      </div>
                    </form>
                  )}
                </div>
              </div>
            </div>
          )}
          {editingId && (
            <div
              className="modal-overlay"
              onClick={cancelEdit}
            >
              <div className="modal-dialog edit-dialog" onClick={e => e.stopPropagation()}>
                <div className="modal-content position-relative p-4">
                  <button
                    type="button"
                    className="btn-close position-absolute top-0 end-0 m-2"
                    onClick={cancelEdit}
                  >
                    X
                  </button>
                  <h5 className="mb-3">Edit Post</h5>
                  <input
                    className="form-control mb-2"
                    value={editTitle}
                    onChange={e => setEditTitle(e.target.value)}
                  />
                  <textarea
                    className="form-control mb-3"
                    rows="6"
                    value={editContent}
                    onChange={e => setEditContent(e.target.value)}
                  />
                  <div className="d-flex justify-content-end">
                    <button
                      className="btn btn-primary me-2"
                      onClick={() => saveEdit(editingId)}
                    >
                      Save
                    </button>
                    <button className="btn btn-secondary" onClick={cancelEdit}>
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
          {showCreate && token && (
            <div
              className="modal-overlay"
              onClick={() => setShowCreate(false)}
            >
              <div className="modal-dialog edit-dialog" onClick={e => e.stopPropagation()}>
                <div className="modal-content position-relative p-4">
                  <button
                    type="button"
                    className="btn-close position-absolute top-0 end-0 m-2"
                    onClick={() => setShowCreate(false)}
                  >
                    X
                  </button>
                  <h5 className="mb-3">Create Post</h5>
                  <form onSubmit={createPost}>
                    <input
                      className="form-control mb-2"
                      placeholder="Title"
                      value={newTitle}
                      onChange={e => setNewTitle(e.target.value)}
                      required
                    />
                    <textarea
                      className="form-control mb-2"
                      placeholder="Content"
                      value={newContent}
                      onChange={e => setNewContent(e.target.value)}
                      required
                    ></textarea>
                    <button className="btn btn-primary" type="submit">
                      Submit
                    </button>
                  </form>
                </div>
              </div>
            </div>
          )}
          <h1 className="mb-4 text-center">RSS Blog</h1>
          {posts.map(post => (
            <div key={post._id || post.link} className="card mb-3 post-card">
              <div className="card-body">
                <h5 className="card-title">
                  <a href={post.link} target="_blank" rel="noopener">
                    {post.title}
                  </a>
                </h5>
                <p className="card-text">{post.contentSnippet}</p>
                <p className="card-text">
                  <small className="text-muted">
                    {
                      (() => {
                        const d = new Date(post.pubDate);
                        return isNaN(d) ? '' : d.toLocaleString();
                      })()
                    }
                  </small>
                </p>
                {token && (
                  <div>
                    <button
                      className="btn btn-sm btn-outline-primary me-2"
                      onClick={() => startEdit(post)}
                    >
                      Edit
                    </button>
                    <button
                      className="btn btn-sm btn-outline-danger"
                      onClick={() => deletePost(post._id)}
                    >
                      Delete
                    </button>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
